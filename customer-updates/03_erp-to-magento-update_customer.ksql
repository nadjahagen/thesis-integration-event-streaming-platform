CREATE TABLE erp_crm_customer_update
   WITH (
      KAFKA_TOPIC='erp-crm-customer-update',
      PARTITIONS=1,
      KEY_FORMAT='KAFKA',
      VALUE_FORMAT='JSON'
   )
   AS SELECT
      e.Email AS email,
      STRUCT (
         `firstname` := e.Firstname,
         `lastname` := e.Lastname,
         `email` := e.Email,
         `taxvat` := e.Taxvat,
         `group_id` := 1,
         `website_id` := 1,
         `addresses` := ARRAY[
            STRUCT(
                `default_billing` := e.DefaultBilling,
                `default_shipping` := e.DefaultShipping,
                `firstname` := e.Firstname,
                `lastname` := e.Lastname,
                `countryId` := e.CountryCode,
                `postcode` := e.Postcode,
                `city` := e.City,
                `street` := ARRAY[CONCAT_WS(' ', e.Street, e.HouseNumber)],
                `telephone` := e.Telephone
            )
         ],
         `custom_attributes` := ARRAY[
            STRUCT(
               `attribute_code` := COALESCE(e.AttributeCode, 'is_approved'),
               `value` := COALESCE(e.Value, 'approved')
            )
         ]
      ) AS customer
   FROM source_erp_customer e
   JOIN source_crm_customer c
       ON e.Email = c.Email
   WHERE e.UpdatedAt != e.CreatedAt;


CREATE STREAM magento_customer_flat
   WITH (
      KAFKA_TOPIC='magento-customer-flat',
      PARTITIONS=1,
      KEY_FORMAT='JSON',
      VALUE_FORMAT='JSON'
   )
   AS SELECT
      value->id AS ID,
      value->confirmation AS confirmation,
      value->email AS email,
      value->firstname AS firstname,
      value->lastname AS lastname,
      value->taxvat AS taxvat,
      value->addresses[1]->street[1] AS street,
      value->addresses[1]->city AS city,
      value->addresses[1]->postcode AS postcode,
      value->addresses[1]->country_id AS country,
      value->addresses[1]->telephone AS telephone,
      value->custom_attributes[1]->value AS status
   FROM source_magento_customer;


CREATE TABLE magento_customer_compacted
   WITH (
      KAFKA_TOPIC='magento-customer-compacted',
      PARTITIONS=1,
      KEY_FORMAT='KAFKA',
      VALUE_FORMAT='JSON'
   )
   AS SELECT
      ID AS ID,
      LATEST_BY_OFFSET(email) AS email,
      LATEST_BY_OFFSET(firstname) AS firstname,
      LATEST_BY_OFFSET(lastname) AS lastname,
      LATEST_BY_OFFSET(taxvat) AS taxvat,
      LATEST_BY_OFFSET(street) AS street,
      LATEST_BY_OFFSET(city) AS city,
      LATEST_BY_OFFSET(postcode) AS postcode,
      LATEST_BY_OFFSET(country) AS country,
      LATEST_BY_OFFSET(telephone) AS telephone,
      LATEST_BY_OFFSET(status) AS status
   FROM magento_customer_flat
   GROUP BY ID;


CREATE TABLE sink_magento_customer_update
   WITH (
      KAFKA_TOPIC='sink-magento-customer-update',
      PARTITIONS=1,
      KEY_FORMAT='KAFKA',
      VALUE_FORMAT='JSON'
   )
   AS SELECT
    a.ID AS magentoID,
    u.customer AS `customer`
   FROM magento_customer_compacted a
    JOIN erp_crm_customer_update u
    ON a.email = u.email;

